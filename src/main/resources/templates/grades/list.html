<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оценки - Журнал</title>
    <link th:replace="~{fragments :: styles}">
</head>
<body>
<div th:replace="~{fragments :: header}"></div>
<div th:replace="~{fragments :: nav}"></div>


<div class="container">
    <div class="content">
        <div class="page-header">
            <h1>Оценки студентов</h1>
            <a href="/grades/new" class="btn btn-success">+ Добавить оценку</a>
        </div>

        <div th:if="${message}" class="alert" th:text="${message}"></div>

        <div class="grade-by-group-block">
            <h2 class="grade-by-group-title">Выставить оценки группе</h2>
            <form method="get" action="/grades" class="grade-by-group-search">
                <input type="hidden" name="studentName" th:value="${studentName}">
                <input type="hidden" name="subjectId" th:value="${subjectId}">
                <div class="form-group">
                    <label for="groupNameForGrades">Название группы</label>
                    <input type="text"
                           id="groupNameForGrades"
                           name="groupNameForGrades"
                           placeholder="Например: ИВТ-101"
                           th:value="${groupNameForGrades}">
                </div>
                <button type="submit" class="btn">Показать студентов</button>
            </form>

            <div th:if="${groupStudents != null and !groupStudents.isEmpty()}" class="grade-by-group-form-wrap">
                <p class="grade-by-group-hint">Укажите оценку каждому студенту (пусто — не выставлять).</p>
                <form method="post" action="/grades/by-group" class="grade-by-group-form-table">
                    <div class="form-group">
                        <label for="byGroupSubjectId">Предмет *</label>
                        <select id="byGroupSubjectId" name="subjectId" required>
                            <option value="">Выберите предмет</option>
                            <option th:each="subject : ${subjects}"
                                    th:value="${subject.id}"
                                    th:text="${subject.name}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="byGroupDate">Дата</label>
                        <input type="date" id="byGroupDate" name="date" th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}">
                    </div>
                    <div class="form-group">
                        <label for="byGroupComment">Комментарий</label>
                        <input type="text" id="byGroupComment" name="comment" placeholder="Необязательно">
                    </div>
                    <div class="table-wrapper grade-by-group-table">
                        <table>
                            <thead>
                            <tr>
                                <th>Студент</th>
                                <th>Номер</th>
                                <th>Оценка</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="student : ${groupStudents}">
                                <td th:text="${student.fullName}">ФИО</td>
                                <td th:text="${student.studentNumber}">№</td>
                                <td>
                                    <input type="hidden" name="studentIds" th:value="${student.id}">
                                    <input type="number" name="values" min="1" max="5" placeholder="—" class="grade-input">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="submit" class="btn btn-success">Сохранить оценки</button>
                </form>
            </div>
            <p th:if="${groupNameForGrades != null and groupNameForGrades != '' and (groupStudents == null or groupStudents.isEmpty())}" class="grade-by-group-empty">
                Студенты по группе «<span th:text="${groupNameForGrades}"></span>» не найдены.
            </p>
        </div>

        <div class="filter-form">
            <form method="get" action="/grades">
                <div class="form-group">
                    <label>Студент</label>

<!--                    <input type="text"-->
<!--                           id="studentSearch"-->
<!--                           placeholder="Введите фамилию студента"-->
<!--                           autocomplete="off">-->
                    <input type="text"
                           name="studentName"
                           placeholder="Введите фамилию студента"
                           th:value="${studentName}">

                    <input type="hidden" name="studentId" id="studentId">

                    <div id="studentResults" class="autocomplete-list"></div>
                </div>
                <div class="form-group">
                    <label for="subjectId">Предмет</label>
                    <select id="subjectId" name="subjectId">
                        <option value="">Все предметы</option>
                        <option th:each="subject : ${subjects}"
                                th:value="${subject.id}"
                                th:text="${subject.name}"
                                th:selected="${subjectId != null and subjectId == subject.id}"></option>
                    </select>
                </div>
                <button type="submit" class="btn">Фильтровать</button>
                <a href="/grades" class="btn">Сбросить</a>
            </form>
        </div>

        <div th:if="${grades != null and !grades.isEmpty()}" class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Студент</th>
                    <th>Предмет</th>
                    <th>Оценка</th>
                    <th>Дата</th>
                    <th>Комментарий</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="grade : ${grades}">
                    <td th:text="${grade.id}"></td>
                    <td th:text="${grade.student.fullName}"></td>
                    <td th:text="${grade.subject.name}"></td>
                    <td th:text="${grade.value}" class="grade-value"></td>
                    <td th:text="${#temporals.format(grade.date, 'dd.MM.yyyy')}"></td>
                    <td th:text="${grade.comment != null ? grade.comment : '-'}"></td>
                    <td>
                        <a th:href="@{/grades/{id}/delete(id=${grade.id})}" class="btn btn-danger btn-small" onclick="return confirm('Вы уверены?')">Удалить</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${grades == null or grades.isEmpty()}" class="empty-state">
            <p>Оценки не найдены. Добавьте первую оценку.</p>
            <a href="/grades/new" class="btn">Добавить оценку</a>
        </div>
    </div>
</div>

<!--<script>-->
<!--    const input = document.getElementById("studentSearch");-->
<!--    const results = document.getElementById("studentResults");-->
<!--    const hiddenId = document.getElementById("studentId");-->

<!--    input.addEventListener("input", async () => {-->
<!--        const query = input.value.trim();-->
<!--        results.innerHTML = "";-->
<!--        hiddenId.value = "";-->

<!--        if (query.length < 2) return;-->

<!--        const response = await fetch(`/students/search?q=${query}`);-->
<!--        const students = await response.json();-->

<!--        students.forEach(s => {-->
<!--            const div = document.createElement("div");-->
<!--            div.className = "autocomplete-item";-->
<!--            div.textContent = `${s.lastName} ${s.firstName} (${s.groupName})`;-->

<!--            div.onclick = () => {-->
<!--                input.value = `${s.lastName} ${s.firstName}`;-->
<!--                hiddenId.value = s.id;-->
<!--                results.innerHTML = "";-->
<!--            };-->

<!--            results.appendChild(div);-->
<!--        });-->
<!--    });-->
<!--</script>-->

</body>
</html>
